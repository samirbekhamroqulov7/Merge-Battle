# üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Supabase

## üî¥ –í–ê–ñ–ù–û: –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤

–í—ã–ø–æ–ª–Ω—è–π—Ç–µ —Å–∫—Ä–∏–ø—Ç—ã **—Å—Ç—Ä–æ–≥–æ –ø–æ –ø–æ—Ä—è–¥–∫—É**:

### –®–∞–≥ 1: –û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
\`\`\`bash
# –§–∞–π–ª: 01-cleanup-database.sql
\`\`\`
–£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã, —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã.

### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
\`\`\`bash
# –§–∞–π–ª: 02-create-tables.sql
\`\`\`
–°–æ–∑–¥–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π.

### –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –∏ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
\`\`\`bash
# –§–∞–π–ª: 03-create-functions-triggers.sql
\`\`\`
–°–æ–∑–¥–∞–µ—Ç –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ RLS –ø–æ–ª–∏—Ç–∏–∫
\`\`\`bash
# –§–∞–π–ª: 04-setup-rls-policies.sql
\`\`\`
–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫.

### –®–∞–≥ 5: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
\`\`\`bash
# –§–∞–π–ª: 05-seed-demo-data.sql
\`\`\`
–î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.

### –®–∞–≥ 6: ‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Auth —Ç—Ä–∏–≥–≥–µ—Ä–∞ (–ö–†–ò–¢–ò–ß–ù–û!)
\`\`\`bash
# –§–∞–π–ª: 06-setup-auth-trigger.sql
\`\`\`

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ auth.users

–¢—Ä–∏–≥–≥–µ—Ä `on_auth_user_created` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω **–æ—Ç –∏–º–µ–Ω–∏ service_role** (postgres).

### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ SQL Editor (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor**
3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
4. –í—Å—Ç–∞–≤—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `06-setup-auth-trigger.sql`
5. –ù–∞–∂–º–∏—Ç–µ **RUN**

### –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ Database Webhooks (–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)

–ï—Å–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ SQL:

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Database** ‚Üí **Webhooks**
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π Webhook:
   - **Table**: `auth.users`
   - **Events**: `INSERT`
   - **Type**: `HTTP Request`
   - **URL**: –í–∞—à API endpoint –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
   - **Method**: `POST`

3. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é:
   - **Type**: `Supabase Function`
   - **Function**: `handle_new_user`

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Authentication

### 1. Email Redirect URLs

–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Authentication** ‚Üí **URL Configuration** –∏ –¥–æ–±–∞–≤—å—Ç–µ:

\`\`\`
http://localhost:3000/auth/callback
https://–≤–∞—à-–¥–æ–º–µ–Ω.vercel.app/auth/callback
\`\`\`

### 2. Google OAuth (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Authentication** ‚Üí **Providers**
2. –í–∫–ª—é—á–∏—Ç–µ **Google**
3. –î–æ–±–∞–≤—å—Ç–µ:
   - **Client ID**: –∏–∑ Google Console
   - **Client Secret**: –∏–∑ Google Console
   - **Authorized redirect URIs** –≤ Google Console:
     \`\`\`
     https://–≤–∞—à-–ø—Ä–æ–µ–∫—Ç.supabase.co/auth/v1/callback
     \`\`\`

### 3. Email Templates

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —à–∞–±–ª–æ–Ω—ã –≤ **Authentication** ‚Üí **Email Templates**:
- Confirm signup
- Magic Link
- Reset Password

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `{{ .ConfirmationURL }}`

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ SQL Editor:

\`\`\`sql
SELECT 
    trigger_name,
    event_manipulation,
    event_object_table,
    action_statement
FROM information_schema.triggers
WHERE trigger_name = 'on_auth_user_created';
\`\`\`

–î–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è 1 —Å—Ç—Ä–æ–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç—Ä–∏–≥–≥–µ—Ä–µ.

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π

\`\`\`sql
SELECT 
    routine_name,
    routine_type
FROM information_schema.routines
WHERE routine_schema = 'public'
AND routine_name IN (
    'handle_new_user',
    'update_mastery_on_win',
    'update_glory_on_win',
    'update_player_rating',
    'create_match_and_update_stats',
    'find_match_opponent'
)
ORDER BY routine_name;
\`\`\`

–î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è 6 —Ñ—É–Ω–∫—Ü–∏–π.

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS

\`\`\`sql
SELECT 
    schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, policyname;
\`\`\`

–î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –≤–∞—à–∏—Ö —Ç–∞–±–ª–∏—Ü.

### 4. –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–æ–∑–¥–∞–ª–∏—Å—å –∑–∞–ø–∏—Å–∏:

\`\`\`sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT id, auth_id, username, email, isGuest FROM users ORDER BY created_at DESC LIMIT 5;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
SELECT u.username, m.level as mastery_level, g.level as glory_level, ps.rating
FROM users u
LEFT JOIN mastery m ON u.id = m.user_id
LEFT JOIN glory g ON u.id = g.user_id
LEFT JOIN player_stats ps ON u.id = ps.user_id
ORDER BY u.created_at DESC
LIMIT 5;
\`\`\`

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: "Infinite loading" –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞

**–ü—Ä–∏—á–∏–Ω—ã:**
1. –¢—Ä–∏–≥–≥–µ—Ä `on_auth_user_created` –Ω–µ —Å–æ–∑–¥–∞–Ω
2. RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç –¥–æ—Å—Ç—É–ø
3. –§—É–Ω–∫—Ü–∏—è `handle_new_user()` –≤—ã–¥–∞–µ—Ç –æ—à–∏–±–∫—É

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ **Logs** ‚Üí **Postgres Logs**
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä —Å–æ–∑–¥–∞–Ω (—Å–º. "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞")
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —Å–æ–∑–¥–∞–µ—Ç—Å—è –ª–∏ –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `users`

### –ü—Ä–æ–±–ª–µ–º–∞: "User profile not found"

**–ü—Ä–∏—á–∏–Ω—ã:**
1. –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. –ü—Ä–æ–±–ª–µ–º—ã —Å —Ç—Ä–∏–≥–≥–µ—Ä–æ–º

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Postgres Logs –Ω–∞ –æ—à–∏–±–∫–∏
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é –≤—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é:
   \`\`\`sql
   SELECT handle_new_user();
   \`\`\`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏–∏

### –ü—Ä–æ–±–ª–µ–º–∞: OAuth –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω—ã:**
1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ redirect URLs
2. –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω Google Provider
3. –ü—Ä–æ–±–ª–µ–º—ã —Å callback

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL Configuration –≤ Authentication
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Google Provider –≤–∫–ª—é—á–µ–Ω
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ Google Console –¥–æ–±–∞–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π redirect URI

## üìû –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–º–æ—â—å

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –æ—Å—Ç–∞—é—Ç—Å—è:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Supabase Dashboard
2. –î–æ–±–∞–≤—å—Ç–µ `console.log("[v0] ...")` –≤ –∫–æ–¥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Browser Console –Ω–∞ –æ—à–∏–±–∫–∏
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Network tab –Ω–∞ failed requests
